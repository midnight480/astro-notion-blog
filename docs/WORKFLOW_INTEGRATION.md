# ワークフロー統合ドキュメント

## 概要

このドキュメントでは、以前の独立した`format.yml`と`lint.yml`ワークフローを置き換えた統合CI/CDワークフローについて説明します。

## 背景

以前、プロジェクトには3つの独立したワークフローがありました：
- `format.yml` - git自動コミット付きの自動フォーマット（権限エラーの原因）
- `lint.yml` - ESLintチェックのみ
- `deploy-workers.yml` - ビルド、テスト、デプロイ

この設定により以下の問題が発生していました：
- `stefanzweifel/git-auto-commit-action@v5`による権限エラー
- 重複した依存関係のインストール
- メンテナンスのオーバーヘッド

## 新しい統合ワークフロー

すべてのコード品質チェックが`deploy-workers.yml`に統合されました：

### ワークフローのステップ

1. **環境変数の検証**
   - 必要な環境変数を検証
   - 処理を進める前に適切な設定を確保

2. **ビルドとテストジョブ**
   - コードのチェックアウト
   - Node.jsのセットアップ
   - 依存関係のインストール
   - **リントチェックの実行** (`npm run lint`)
   - **フォーマットチェックの実行** (`npm run format:check`)
   - NX Cloudのセットアップ（利用可能な場合）
   - アプリケーションのビルド
   - 全テストの実行
   - ビルド成果物のアップロード

3. **デプロイジョブ**
   - ステージングへのデプロイ（feature/page-to-workersブランチ）
   - 本番環境へのデプロイ（mainブランチ）

### メリット

- **権限エラーなし**: 自動コミット機能を削除
- **高速CI**: 単一の依存関係インストール
- **早期失敗**: コード品質の問題で早期にデプロイを停止
- **メンテナンスの簡素化**: 管理するワークフローが1つ
- **セキュリティの向上**: 自動的なコード変更なし

## 開発者ワークフロー

### コミット前の作業

ローカルで必ず以下のコマンドを実行してください：

```bash
# コードをフォーマット
npm run format

# リントの問題をチェック
npm run lint

# フォーマットを確認
npm run format:check

# テストを実行
npm run test:all
```

### CIの動作

- **リント失敗**: ワークフロー停止、デプロイキャンセル
- **フォーマット問題**: ワークフロー停止、デプロイキャンセル
- **ビルド失敗**: ワークフロー停止、デプロイキャンセル
- **テスト失敗**: ワークフロー停止、デプロイキャンセル

### 手動修正が必要

ワークフローは問題を自動修正しません。開発者は以下を行う必要があります：

1. `npm run format`を実行してフォーマットを修正
2. リントエラーを手動で修正（または`npm run lint --fix`が利用可能な場合は使用）
3. 修正をコミット
4. 再度プッシュしてワークフローをトリガー

## 移行の概要

### 削除されたファイル
- `.github/workflows/format.yml` ❌
- `.github/workflows/lint.yml` ❌

### 変更されたファイル
- `.github/workflows/deploy-workers.yml` ✅ （リントとフォーマットチェックを追加）

### 追加されたスクリプト
- `npm run format:check` ✅ （修正なしでフォーマットを検証）

### 変更なし
- `npm run format` ✅ （手動フォーマット）
- `npm run lint` ✅ （リントチェック）
- 既存のビルドとテストスクリプト全て ✅

## トラブルシューティング

### ワークフローがリントで失敗する場合
```bash
# ローカルでリントの問題をチェック
npm run lint

# 問題を手動で修正してから、コミット・プッシュ
```

### ワークフローがフォーマットで失敗する場合
```bash
# フォーマットの問題をチェック
npm run format:check

# フォーマットを修正
npm run format

# フォーマット済みのコードをコミット・プッシュ
```

### 権限エラー
自動コミット機能が削除されたため、もう発生しないはずです。権限エラーが発生した場合は、Issueを作成してください。